<% layout('layout/boilerplate') %>
    <div class="row">
        <h1 class="text-center mb-4 mt-3">Lend Items</h1>

        <!-- ðŸ” Search & Filters -->
        <div class="container mb-4 px-0">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-md-11 col-sm-12">

                    <!-- Search Bar -->
                    <div class="mb-3 position-relative">
                        <input type="text" id="itemSearch" class="form-control form-control-lg shadow-sm" placeholder="ðŸ” Search by item, category, or supplier...">
                        <ul id="suggestionList" class="list-group position-absolute w-100" style="z-index: 1000; display:none;"></ul>
                    </div>

                    <!-- Filters -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <select id="filterCategory" class="form-select form-select-lg shadow-sm">
              <option value="">All Categories</option>
              <% itemCategories.forEach(cat => { %>
                <option value="<%= cat.itemCategoryName %>"><%= cat.itemCategoryName %></option>
              <% }) %>
            </select>
                        </div>

                        <div class="col-md-6">
                            <select id="filterSupplier" class="form-select form-select-lg shadow-sm">
              <option value="">All Suppliers</option>
              <% itemSuppliers.forEach(sup => { %>
                <option value="<%= sup.supplierName %>"><%= sup.supplierName %></option>
              <% }) %>
            </select>
                            <div class="col-12 text-end mt-2">
                                <button id="resetFilters" class="btn btn-outline-secondary btn-sm">Reset Filters</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- ðŸ“¦ Items Table -->
        <div class="col-lg-10 col-md-11 col-sm-12 mx-auto">
            <form action="/items/lend" method="POST" novalidate class="validated-form">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Item Name</th>
                            <th>Current Stock</th>
                            <th>Quantity</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>

                    <tbody>
                        <% items.forEach((item, i) => { %>

                            <tr class="item-row" data-name="<%= item.itemName %>" data-category="<%= item.itemCategoryName %>" data-supplier="<%= item.itemSupplier %>">
                                <td style="width: 80px;">
                                    <% if (item.itemImage && item.itemImage.length > 0) { %>
                                        <img src="<%= item.base64Image %>" class="img-thumbnail clickable-image" style="height:60px;width:60px;object-fit:contain;cursor:pointer;" onclick="openImage('<%= item.base64Image %>', '<%= item.itemName %>.jpg')">

                                        <% } else { %>
                                            <img src='https://via.placeholder.com/60x60.png?text=No+Image' class='img-thumbnail clickable-image' style='height:60px; width:60px; object-fit:contain; background:#f8f9fa; border-radius:6px; cursor:pointer;' onclick="openImage('https://via.placeholder.com/600x600.png?text=No+Image', 'NoImage.jpg')">
                                            <% } %>
                                </td>


                                <td>
                                    <%= item.itemName %>
                                </td>
                                <td>
                                    <%= item.itemQty %>
                                        <%= item.itemUnit %>
                                </td>
                                <td>
                                    <input type="hidden" name="items[<%= i %>][id]" value="<%= item._id %>">
                                    <input type="number" class="form-control" name="items[<%= i %>][lendQty]" min="0" max="<%= item.itemQty %>" value="0" required>
                                </td>
                                <td>
                                    <input type="text" class="form-control" name="items[<%= i %>][remarks]" placeholder="Optional remarks">
                                </td>
                            </tr>
                            <% }) %>
                    </tbody>
                </table>
                <button class="btn btn-primary my-2">Lend Items</button>
            </form>
        </div>
        <!-- ðŸ–¼ï¸ Fullscreen Image Viewer Modal -->
        <div id="imagePreviewModal" class="fullscreen-overlay" style="display:none;">
            <span class="close-btn" onclick="closeImage()">&times;</span>
            <a id="downloadBtn" class="download-btn" download>
                <i class="bi bi-download"></i> Download
            </a>
            <img id="previewImage" src="" alt="Item Image">
        </div>

    </div>

    <!-- ðŸ§  Copy JS from outwards.ejs -->
    <script src="/javascripts/filter-search.js"></script>
    <script>
        const searchInput = document.getElementById('itemSearch');
        const suggestionList = document.getElementById('suggestionList');
        const categoryFilter = document.getElementById('filterCategory');
        const supplierFilter = document.getElementById('filterSupplier');
        const allRows = document.querySelectorAll('.item-row'); // assuming each item row has class 'item-row'

        // ðŸŸ¢ Live suggestions as user types
        searchInput.addEventListener('input', async function() {
            const query = this.value.trim();
            if (!query) {
                suggestionList.style.display = 'none';
                filterTable();
                return;
            }

            const res = await fetch(`/items/suggestions?q=${encodeURIComponent(query)}`);
            const items = await res.json();

            suggestionList.innerHTML = '';
            if (items.length === 0) {
                suggestionList.style.display = 'none';
                return;
            }

            items.forEach(it => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action';
                li.textContent = `${it.itemName} (${it.itemCategoryName} - ${it.itemSupplier})`;
                li.addEventListener('click', () => {
                    searchInput.value = it.itemName;
                    suggestionList.style.display = 'none';
                    filterTable();
                });
                suggestionList.appendChild(li);
            });

            suggestionList.style.display = 'block';
        });

        // ðŸŸ¢ Hide suggestions when clicking outside
        document.addEventListener('click', e => {
            if (!suggestionList.contains(e.target) && e.target !== searchInput) {
                suggestionList.style.display = 'none';
            }
        });

        // ðŸŸ¢ Apply filters dynamically
        [searchInput, categoryFilter, supplierFilter].forEach(el => {
            el.addEventListener('input', filterTable);
            el.addEventListener('change', filterTable);
        });

        function filterTable() {
            const search = searchInput.value.trim().toLowerCase();
            const category = categoryFilter.value.trim().toLowerCase();
            const supplier = supplierFilter.value.trim().toLowerCase();

            allRows.forEach(row => {
                const name = row.dataset.name.toLowerCase();
                const cat = row.dataset.category.toLowerCase();
                const sup = row.dataset.supplier.toLowerCase();

                const matchesSearch = !search || name.includes(search) || cat.includes(search) || sup.includes(search);
                const matchesCategory = !category || cat === category;
                const matchesSupplier = !supplier || sup === supplier;

                row.style.display = (matchesSearch && matchesCategory && matchesSupplier) ? '' : 'none';
            });
        }
        document.getElementById('resetFilters').addEventListener('click', () => {
            searchInput.value = '';
            categoryFilter.value = '';
            supplierFilter.value = '';
            filterTable();
        });
    </script>

    <script src="/javascripts/form-navigation.js"></script>
    <script>
        let scrollPosition = 0;

        function openImage(imgSrc, fileName) {
            const modal = document.getElementById("imagePreviewModal");
            const preview = document.getElementById("previewImage");
            const download = document.getElementById("downloadBtn");

            scrollPosition = window.scrollY; // Save position
            preview.src = imgSrc;
            download.href = imgSrc;
            download.download = fileName || "image.jpg";
            modal.style.display = "flex";

            document.body.style.overflow = "hidden"; // Prevent scrolling
        }

        function closeImage() {
            const modal = document.getElementById("imagePreviewModal");
            modal.style.display = "none";
            document.body.style.overflow = ""; // Restore scroll
            window.scrollTo(0, scrollPosition); // Return to last position
        }
    </script>



    <style>
        #itemSearch {
            font-size: 1rem;
            padding: 12px 14px;
            border-radius: 8px;
        }
        
        .form-select {
            border-radius: 8px;
        }
        
        #suggestionList li {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #suggestionList li:hover {
            background-color: #f8f9fa;
        }
        
        .img-thumbnail {
            border: 1px solid #dee2e6;
            padding: 2px;
            background-color: #fff;
        }
        
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            flex-direction: column;
        }
        
        .fullscreen-overlay img {
            max-width: 90%;
            max-height: 85%;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            z-index: 2100;
        }
        
        .download-btn {
            position: absolute;
            top: 20px;
            left: 30px;
            background: #198754;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 2100;
        }
        
        .download-btn:hover {
            background: #157347;
            text-decoration: none;
            color: white;
        }
        
        .clickable-image:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
    </style>