<% layout('layout/boilerplate') %>
    <div class="row">
        <h1 class="text-center">Edit Item</h1>
        <div class="col-6 offset-3">
            <form action="/items/<%= item._id %>?_method=PUT" method="POST" novalidate class="validated-form" enctype="multipart/form-data">
                <div class="mb-2">
                    <label for="name" class="form-label">Item Name</label>
                    <input type="text" id="name" name="item[itemName]" class="form-control" value="<%= item.itemName %>" required>
                </div>

                <div class="mb-2">
                    <label for="description" class="form-label">Item Description</label>
                    <input type="text" id="description" name="item[itemDescription]" class="form-control" value="<%= item.itemDescription %>" required>
                </div>

                <div class="mb-2">
                    <label for="unit" class="form-label">Item Quantity Unit</label>
                    <select class="form-select form-select-lg" name="item[itemUnit]" id="unit" required>
                        <option selected><%= item.itemUnit %> </option>
                        <option value="NOS">NOS</option>
                        <option value="PCS">PCS</option>
                        <option value="PCS">BAGS</option>
                        <option value="BOX">BOX</option>
                        <option value="KGS">KGS</option>
                        <option value="SETS">SETS</option>
                    </select>
                </div>

                <div class="mb-2">
                    <label for="quantity" class="form-label">Item Quantity</label>
                    <input type="text" id="quantity" name="item[itemQty]" class="form-control" value="<%= item.itemQty %>" required>
                </div>
                <!-- Add the input field for Life -->
                <label class="form-label" for="life">Daily Consumption</label>
                <input class="form-control" type="text" id="life" name="item[life]" value="<%= item.life %>" placeholder="e.g, 1 HEATS, 5 HEATS, 1 DAY,">
                <div class="mb-2">
                    <label for="category" class="form-label">Item Category</label>
                    <select class="form-select form-select-lg" name="item[itemCategoryName]" id="category" required>
                        <option selected disabled><%= item.itemCategoryName %> </option>
                        <!-- <option disabled selected>Select Item Category</option> -->
                            <% for(let category of itemCategories){%>

            <option>
                <%= category.itemCategoryName %>

            </option>

            <%} %>
                        <!-- <option value="CCM REFRACTORIES">CCM REFRACTORIES</option>
                        <option value="CCM SPARE PARTS">CCM SPARE PARTS</option>
                        <option value="FURNACE CONSUMABLES">FURNACE CONSUMABLES</option>
                        <option value="FURNACE REFRACTORIES">FURNACE REFRACTORIES</option>
                        <option value="FURNACE SPARE PARTS">FURNACE SPARE PARTS</option> -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="supplier" class="form-label">Item Supplier</label>
                    <select class="form-select form-select-lg" name="item[itemSupplier]" id="supplier" required>
                        <option selected disabled><%= item.itemSupplier %> </option>
    <% itemSuppliers.forEach(supplier => { %>
      <option value="<%= supplier.supplierName %>">
        <%= supplier.supplierName %> (<%= supplier.supplierCity %>)
      </option>
    <% }) %>
  </select>
                    <a class="btn btn-primary mt-2" href="/supplier/new">+ Add New Supplier</a>

                </div>
                <div class="mb-3">
                    <label class="form-label">Current Images</label>
                    <div class="d-flex flex-wrap gap-3">
                        <% if (item.itemImage.length > 0) { %>
                            <% item.itemImage.forEach(img => { %>
                                <div class="text-center">
                                    <img src="data:image/<%= img.contentType %>;base64,<%= img.data.toString('base64') %>" alt="<%= img.name %>" class="img-thumbnail zoomable" style="width:120px; height:120px; object-fit:contain; cursor: zoom-in;">
                                    <div class="mt-1">
                                        <a href="data:image/<%= img.contentType %>;base64,<%= img.data.toString('base64') %>" download="<%= img.name %>" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <a href="/items/<%= item._id %>/view" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p class="text-muted">No images uploaded.</p>
                                        <% } %>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Current Images</label>
                    <div class="d-flex flex-wrap gap-3">
                        <% if (item.itemImage.length > 0) { %>
                            <% item.itemImage.forEach(img => { %>
                                <div class="text-center border rounded p-2">
                                    <img src="data:image/<%= img.contentType %>;base64,<%= img.data.toString('base64') %>" alt="<%= img.name %>" class="img-thumbnail zoomable" style="width:120px; height:120px; object-fit:contain; cursor: zoom-in;">
                                    <div class="mt-1">
                                        <a href="data:image/<%= img.contentType %>;base64,<%= img.data.toString('base64') %>" download="<%= img.name %>" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-download"></i>
                                        </a>
                                        <label class="form-check-label text-danger small ms-2">
              <input type="checkbox" name="deleteImages[]" value="<%= img._id %>">
              Delete
            </label>
                                    </div>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p class="text-muted">No images uploaded.</p>
                                        <% } %>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="image" class="form-label">Add / Replace Images</label>
                    <input class="form-control" type="file" id="image" name="item[itemImage]" multiple>
                    <small class="text-muted">
    You can delete specific old images above or upload new ones to add / replace.
  </small>
                </div>


                <button class="btn btn-success my-3" onclick="return confirm('Save changes?')">Save Item</button>

                <!-- Fullscreen modal for image preview -->
                <div class="modal fade" id="imageModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-fullscreen">
                        <div class="modal-content bg-dark">
                            <div class="modal-body p-0 text-center">
                                <img id="modalImage" class="img-fluid" style="max-height: 95vh;">
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    document.querySelectorAll('.zoomable').forEach(img => {
                        img.addEventListener('click', () => {
                            document.getElementById('modalImage').src = img.src;
                            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                            modal.show();
                        });
                    });
                </script>


            </form>
        </div>
    </div>