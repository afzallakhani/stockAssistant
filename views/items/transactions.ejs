<%- layout('layout/boilerplate') %>

    <h1>All Transactions</h1>

    <!-- Your filter form can remain here -->
    <!-- Example: -->
    <!-- 
<form action="/items/transactions" method="GET" class="row g-3 mb-4 align-items-center">
    ... your filter inputs for item, start date, and end date ...
</form>
-->

    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th style="width: 15%;">Time</th>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Stock Before</th>
                    <th>Stock After</th>
                    <th style="width: 10%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <% if (sortedDates.length > 0) { %>
                    <% sortedDates.forEach(dateKey => { %>
                        <!-- Date Group Header -->
                        <tr class="table-light">
                            <td colspan="7" class="fw-bold text-center">
                                <%= new Date(dateKey).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                            </td>
                        </tr>

                        <!-- Transactions for this Date -->
                        <% groupedTransactions[dateKey].forEach(tx => { %>
                            <tr>
                                <td>
                                    <%= new Date(tx.createdAt).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) %>
                                </td>
                                <td>
                                    <% if (tx.itemId) { %>
                                        <%= tx.itemId.itemName %>
                                            <% } else { %>
                                                <span class="text-muted">Item Deleted</span>
                                                <% } %>
                                </td>
                                <td>
                                    <% 
                                let badgeClass = 'bg-secondary';
                                if (tx.type === 'inward') badgeClass = 'bg-success';
                                else if (tx.type === 'outward') badgeClass = 'bg-danger';
                                else if (tx.type === 'initial') badgeClass = 'bg-primary';
                                %>
                                        <span class="badge <%= badgeClass %> text-capitalize"><%= tx.type %></span>
                                </td>
                                <td>
                                    <%= tx.quantity %>
                                </td>
                                <td>
                                    <%= tx.stockBefore %>
                                </td>
                                <td>
                                    <%= tx.stockAfter %>
                                </td>
                                <td>
                                    <% if (tx.type !== 'initial') { %>
                                        <form action="/items/transactions/<%= tx._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to reverse this transaction? This action cannot be undone.');">
                                            <button class="btn btn-sm btn-outline-danger">Reverse</button>
                                        </form>
                                        <% } %>
                                </td>
                            </tr>
                            <% }) %>
                                <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center p-4">No transactions found for the selected criteria.</td>
                                        </tr>
                                        <% } %>
            </tbody>
        </table>
    </div>