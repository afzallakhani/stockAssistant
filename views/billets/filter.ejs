<%- layout('layout/boilerplate') %>

    <h1>Filter Billets</h1>

    <!-- Filter Form -->
    <form action="/billets/filter" method="GET" class="mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" id="startDate" name="startDate" value="<%= startDate || '' %>" class="form-control">
            </div>
            <div class="col-md-2">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" id="endDate" name="endDate" value="<%= endDate || '' %>" class="form-control">
            </div>
            <div class="col-md-2">
                <label for="heatType" class="form-label">Heat Type</label>
                <select id="heatType" name="heatType" class="form-select">
                <option value="all" <%= heatType === 'all' ? 'selected' : '' %>>All</option>
                <option value="open" <%= heatType === 'open' ? 'selected' : '' %>>Open Cast</option>
                <option value="close" <%= heatType === 'close' ? 'selected' : '' %>>Close Cast</option>
            </select>
            </div>
            <div class="col-md-2">
                <label for="sectionSize" class="form-label">Section Size</label>
                <select id="sectionSize" name="sectionSize" class="form-select">
                <option value="all" <%= sectionSize === 'all' ? 'selected' : '' %>>All</option>
                <option value="100X100" <%= sectionSize === '100X100' ? 'selected' : '' %>>100X100</option>
                <option value="130X130" <%= sectionSize === '130X130' ? 'selected' : '' %>>130X130</option>
                <option value="160X160" <%= sectionSize === '160X160' ? 'selected' : '' %>>160X160</option>
                <option value="200X200" <%= sectionSize === '200X200' ? 'selected' : '' %>>200X200</option>
            </select>
            </div>
            <div class="col-md-2">
                <label for="grade" class="form-label">Grade</label>
                <select id="grade" name="grade" class="form-select">
                <option value="all" <%= grade === 'all' ? 'selected' : '' %>>All</option>
                <% uniqueGrades.sort().forEach(g => { %>
                    <option value="<%= g %>" <%= grade === g ? 'selected' : '' %>><%= g %></option>
                <% }) %>
            </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
        </div>
    </form>

    <!-- Display Results -->
    <% if (count > 0) { %>
        <div class="alert alert-info">
            <h3>Results: Found
                <%= count %> Heats</h3>

            <!-- Section-wise Counts -->
            <% if (Object.keys(sectionCounts).length > 0) { %>
                <hr>
                <strong>Heats by Section:</strong>
                <ul>
                    <% for (const [size, num] of Object.entries(sectionCounts).sort()) { %>
                        <li>
                            <%= size %>:
                                <%= num %> Heats</li>
                        <% } %>
                </ul>
                <% } %>

                    <!-- Daily Average -->
                    <% if (numberOfDays > 0) { %>
                        <hr>
                        <p><strong>Number of Days in Range:</strong>
                            <%= numberOfDays %>
                        </p>
                        <p><strong>Average Heats Per Day:</strong>
                            <%= avgHeatsPerDay %>
                        </p>
                        <% } %>
        </div>
        <% } else if (startDate || endDate || heatType || sectionSize || grade) { %>
            <div class="alert alert-warning">
                No heats found for the selected criteria.
            </div>
            <% } %>

                <!-- Heats Table -->
                <% if (heats && heats.length > 0) { %>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Date</th>
                                    <th>Heat No.</th>
                                    <th>Grade</th>
                                    <th>Section</th>
                                    <th>C %</th>
                                    <th>Mn %</th>
                                    <th>P %</th>
                                    <th>S %</th>
                                    <th>Si %</th>
                                    <th>Cr %</th>
                                    <th>Mo %</th>
                                    <th>Ni %</th>
                                    <th>Al %</th>
                                    <th>Cu %</th>
                                    <th>V %</th>
                                    <th>Nb %</th>
                                    <th>CE %</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% heats.forEach((list, index) => { %>
                                    <tr>
                                        <td>
                                            <%= index + 1 %>
                                        </td>
                                        <td>
                                            <%= list.formattedHeatDate %>
                                        </td>
                                        <td>
                                            <%= list.heatNo %>
                                        </td>
                                        <td>
                                            <%= list.gradeName %>
                                        </td>
                                        <td>
                                            <%= list.sectionSize %>
                                        </td>
                                        <td>
                                            <%= list.c %>
                                        </td>
                                        <td>
                                            <%= list.mn %>
                                        </td>
                                        <td>
                                            <%= list.p %>
                                        </td>
                                        <td>
                                            <%= list.s %>
                                        </td>
                                        <td>
                                            <%= list.si %>
                                        </td>
                                        <td>
                                            <%= list.cr || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.mo || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.ni || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.al || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.cu || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.v || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.nb || 'N/A' %>
                                        </td>
                                        <td>
                                            <%= list.ce || 'N/A' %>
                                        </td>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <% } %>